<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IT Park - Strategic Command</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ADMIN CORE STYLES --- */
        :root {
            --neon-green: #39ff14;
            --neon-blue: #00f3ff;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --dark-sidebar: #0f172a;
            --text-main: #1e293b;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f1f5f9; }

        .admin-container { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .admin-sidebar { 
            width: 260px; 
            background: var(--dark-sidebar); 
            color: white; 
            padding: 20px; 
            flex-shrink: 0; 
            display: flex;
            flex-direction: column;
        }
        
        .admin-brand { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; }
        .admin-brand img { height: 35px; }
        .admin-brand span { font-weight: 700; font-size: 1.2rem; letter-spacing: 0.5px; }

        .admin-nav button {
            width: 100%; text-align: left; padding: 14px; background: transparent;
            border: none; color: #94a3b8; cursor: pointer; border-radius: 8px;
            margin-bottom: 8px; font-size: 0.95rem; display: flex; gap: 12px; align-items: center;
            transition: all 0.3s ease;
        }
        .admin-nav button:hover { background: rgba(255,255,255,0.1); color: white; padding-left: 20px; }
        .admin-nav button.active { background: linear-gradient(90deg, #7dba28 0%, #5da008 100%); color: white; box-shadow: 0 4px 15px rgba(125,186,40,0.3); }

        /* Content Area */
        .admin-content { flex: 1; padding: 40px; overflow-y: auto; }
        
        h1 { font-size: 1.8rem; margin-bottom: 25px; color: var(--text-main); border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; }

        /* --- DASHBOARD GRID SYSTEM --- */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 25px; 
            margin-bottom: 30px; 
        }

        .stat-card { 
            background: var(--glass-bg); 
            padding: 25px; 
            border-radius: 16px; 
            border: 1px solid #e2e8f0; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-info .label { color: #64748b; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-info .value { font-size: 2.2rem; font-weight: 800; color: var(--text-main); margin-top: 5px; }
        
        .stat-icon {
            width: 50px; height: 50px; border-radius: 12px;
            background: rgba(125, 186, 40, 0.1); color: #7dba28;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
        }

        /* --- CHART CONTAINERS --- */
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px; }
        
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            height: 400px; /* Fixed height for consistency */
        }
        
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .chart-header h3 { margin: 0; font-size: 1.1rem; color: #334155; }

        /* Data Table */
        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .data-table th { background: #f8fafc; font-weight: 600; color: #64748b; text-transform: uppercase; font-size: 0.8rem; }
        .user-row img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 12px; vertical-align: middle; }
        .badge { background: #f1f5f9; padding: 4px 8px; border-radius: 6px; font-size: 0.85rem; color: #475569; font-weight: 500; }

    </style>
</head>
<body>

<div class="admin-container">
    <aside class="admin-sidebar">
        <div class="admin-brand">
            <img src="img/LOGO_ITParkll.png" style="filter: brightness(0) invert(1);" alt="Logo">
            <span>Admin</span>
        </div>
        <nav class="admin-nav">
            <button class="active" onclick="switchView('dashboard', this)">
                <i class="fa-solid fa-chart-pie"></i> Analytics Hub
            </button>
            <button onclick="switchView('users', this)">
                <i class="fa-solid fa-users-gear"></i> User Management
            </button>
            <div style="flex-grow:1"></div>
            <button onclick="window.location.href='/'" style="color:#ff4757;">
                <i class="fa-solid fa-power-off"></i> Exit Console
            </button>
        </nav>
    </aside>

    <main class="admin-content">
        
        <div id="view-dashboard">
            <h1>Strategic Ecosystem Overview</h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-info">
                        <div class="label">Total Executives</div>
                        <div class="value" id="total-users">0</div>
                    </div>
                    <div class="stat-icon"><i class="fa-solid fa-user-tie"></i></div>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <div class="label">Intel Saved</div>
                        <div class="value" id="total-saved">0</div>
                    </div>
                    <div class="stat-icon" style="color:#3b82f6; background:rgba(59,130,246,0.1);"><i class="fa-solid fa-bookmark"></i></div>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <div class="label">System Status</div>
                        <div class="value" style="color:#22c55e; font-size:1.5rem;">‚óè Online</div>
                    </div>
                    <div class="stat-icon" style="color:#22c55e; background:rgba(34,197,94,0.1);"><i class="fa-solid fa-server"></i></div>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Department Penetration</h3>
                        <i class="fa-solid fa-chart-pie" style="color:#94a3b8;"></i>
                    </div>
                    <div style="height: 300px; display:flex; justify-content:center;">
                        <canvas id="deptChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Top Strategic Interests</h3>
                        <i class="fa-solid fa-chart-simple" style="color:#94a3b8;"></i>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="topicChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-card" style="height: 350px;">
                <div class="chart-header">
                    <h3>Engagement Pulse (Last 7 Days)</h3>
                    <i class="fa-solid fa-wave-square" style="color:#94a3b8;"></i>
                </div>
                <div style="height: 280px;">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <div id="view-users" style="display:none;">
            <h1>User Database</h1>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>User Profile</th>
                        <th>Email Contact</th>
                        <th>Department</th>
                        <th>Access Role</th>
                        <th>Join Date</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    </tbody>
            </table>
        </div>

    </main>
</div>

<script>
    // 1. Navigation Logic
    function switchView(viewName, btn) {
        // Hide all views
        document.getElementById('view-dashboard').style.display = 'none';
        document.getElementById('view-users').style.display = 'none';
        
        // Show selected view
        document.getElementById('view-' + viewName).style.display = 'block';

        // Update Button State
        if(btn) {
            document.querySelectorAll('.admin-nav button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    }

    // 2. Chart Configuration
    const chartColors = {
        green: '#7dba28',
        blue: '#3b82f6',
        purple: '#8b5cf6',
        slate: '#64748b'
    };

    async function initAdminPanel() {
        try {
            // Fetch ALL data from the new Analytics API
            const res = await fetch('/analytics/data');
            
            if(res.status === 401 || res.status === 403) {
                alert("Restricted Access: Admins Only.");
                window.location.href = '/';
                return;
            }

            const data = await res.json();
            console.log("Analytics Data:", data);

            // --- A. POPULATE METRICS ---
            const totalUsers = data.deptData.reduce((sum, item) => sum + item.count, 0);
            const totalSaved = data.topicData.reduce((sum, item) => sum + item.count, 0);
            
            document.getElementById('total-users').innerText = totalUsers;
            document.getElementById('total-saved').innerText = totalSaved; // Or fetch real count if easier

            // --- B. RENDER CHARTS ---
            
            // 1. Department Pie Chart
            new Chart(document.getElementById('deptChart'), {
                type: 'doughnut',
                data: {
                    labels: data.deptData.map(d => d.department),
                    datasets: [{
                        data: data.deptData.map(d => d.count),
                        backgroundColor: [chartColors.green, chartColors.blue, chartColors.purple, '#f43f5e', '#f59e0b'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });

            // 2. Topics Bar Chart
            new Chart(document.getElementById('topicChart'), {
                type: 'bar',
                data: {
                    labels: data.topicData.map(t => t.topic),
                    datasets: [{
                        label: 'Saved Articles',
                        data: data.topicData.map(t => t.count),
                        backgroundColor: chartColors.blue,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // 3. Activity Line Chart
            new Chart(document.getElementById('timelineChart'), {
                type: 'line',
                data: {
                    labels: data.timelineData.map(t => t.date),
                    datasets: [{
                        label: 'Daily Activity',
                        data: data.timelineData.map(t => t.count),
                        borderColor: chartColors.green,
                        backgroundColor: 'rgba(125, 186, 40, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { precision: 0 } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // --- C. POPULATE USER TABLE (If needed) ---
            // You might want to make a separate call for this if the list is huge
            // For now, assuming you might add a separate endpoint for the list
            fetch('/admin/stats').then(r => r.json()).then(userData => {
                 const tbody = document.getElementById('users-table-body');
                 if(userData.users) {
                     tbody.innerHTML = userData.users.map(u => `
                        <tr class="user-row">
                            <td><img src="${u.photo_url || 'img/default-user.png'}"><b>${u.name}</b></td>
                            <td>${u.email}</td>
                            <td><span class="badge">${u.department || 'N/A'}</span></td>
                            <td>${u.role}</td>
                            <td>${new Date(u.created_at).toLocaleDateString()}</td>
                        </tr>
                     `).join('');
                 }
            });

        } catch (err) {
            console.error("Dashboard Error:", err);
        }
    }

    // Initialize on Load
    window.addEventListener('DOMContentLoaded', initAdminPanel);
</script>

</body>
</html>